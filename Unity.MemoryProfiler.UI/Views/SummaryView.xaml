<UserControl x:Class="Unity.MemoryProfiler.UI.Views.SummaryView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Unity.MemoryProfiler.UI.Views"
             xmlns:converters="clr-namespace:Unity.MemoryProfiler.UI.Converters"
             xmlns:vm="clr-namespace:Unity.MemoryProfiler.UI.ViewModels"
             xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1000"
             Background="White">
    <UserControl.Resources>
        <ResourceDictionary>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <converters:NotNullToVisibilityConverter x:Key="NotNullToVisibilityConverter"/>
        <converters:PercentageToWidthConverter x:Key="PercentageToWidthConverter"/>
            <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
            <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>

            <Style x:Key="SummarySectionButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderBrush" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="Padding" Value="0"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <ContentPresenter/>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
            </Style>

            <Style x:Key="SummaryListButtonStyle" TargetType="Button">
                <Setter Property="Background" Value="Transparent"/>
                <Setter Property="BorderBrush" Value="Transparent"/>
                <Setter Property="BorderThickness" Value="0"/>
                <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                <Setter Property="Padding" Value="4"/>
                <Setter Property="Cursor" Value="Hand"/>
                <Setter Property="Template">
                    <Setter.Value>
                        <ControlTemplate TargetType="Button">
                            <Border Background="{TemplateBinding Background}" Padding="{TemplateBinding Padding}">
                                <ContentPresenter/>
                            </Border>
                        </ControlTemplate>
                    </Setter.Value>
                </Setter>
                <Setter Property="HorizontalAlignment" Value="Stretch"/>
            </Style>
        </ResourceDictionary>
    </UserControl.Resources>
    
    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="20">
        <StackPanel>
            <TextBlock Text="Memory Usage Summary" FontSize="24" FontWeight="Bold" Margin="0,0,0,20"/>

            <TextBlock Text="{Binding StatusMessage}" 
                       FontSize="14" 
                       Foreground="Gray" 
                       Margin="0,0,0,20"
                       Visibility="{Binding SummaryData, Converter={StaticResource NullToVisibilityConverter}}"/>

            <!-- Issues Panel -->
            <Border Background="#FFF8E1"
                    BorderBrush="#FFE0B2"
                    BorderThickness="1"
                    CornerRadius="6"
                    Padding="12"
                    Margin="0,0,0,20"
                    Visibility="{Binding HasIssues, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel>
                    <TextBlock Text="Potential Issues" FontSize="16" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <ItemsControl ItemsSource="{Binding Issues}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <Border Background="White" BorderBrush="#FFE0B2" BorderThickness="1" CornerRadius="4" Padding="10" Margin="0,0,0,10">
                                    <StackPanel>
                                        <TextBlock Text="{Binding Summary}" FontWeight="SemiBold" Margin="0,0,0,4"/>
                                        <TextBlock Text="{Binding Details}" TextWrapping="Wrap" Foreground="#5D4037"/>
                                    </StackPanel>
                                </Border>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Normalized Toggle -->
            <StackPanel Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,0,0,10"
                        Visibility="{Binding ShowNormalizedToggle, Converter={StaticResource BoolToVisibilityConverter}}">
                <ToggleButton Content="Normalized"
                              Width="110"
                              Padding="10,4"
                              IsChecked="{Binding IsNormalized, Mode=TwoWay}"
                              IsEnabled="{Binding NormalizedToggleEnabled}"/>
                <TextBlock Text="{Binding NormalizedLabel}" Margin="8,4,0,0" VerticalAlignment="Center" Foreground="Gray"/>
            </StackPanel>
                
            <!-- Memory Usage Section -->
            <Border BorderBrush="#E0E0E0" BorderThickness="1" Padding="15" Background="#FAFAFA" Margin="0,0,0,20">
                <StackPanel>
                    <TextBlock Text="Memory Usage On Device" FontSize="18" FontWeight="SemiBold" Margin="0,0,0,10"/>
                    <TextBlock Text="Displays how much memory you have allocated to the system, and how much of that memory is currently Resident on device." 
                               TextWrapping="Wrap" Foreground="Gray" Margin="0,0,0,15"/>
                    
                    <!-- 单快照模式 (可点击) -->
                    <Button Style="{StaticResource SummarySectionButtonStyle}" 
                            Command="{Binding ShowMemoryUsageDetailsCommand}"
                            Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                        <StackPanel>
                            <Grid Height="40" Margin="0,0,0,10">
                                <Rectangle Fill="#E0E0E0" RadiusX="4" RadiusY="4"/>
                                <Rectangle Fill="#4CAF50" RadiusX="4" RadiusY="4" HorizontalAlignment="Left">
                                    <Rectangle.Width>
                                        <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                            <Binding Path="SummaryData.MemoryUsage.ResidentPercentage"/>
                                            <Binding RelativeSource="{RelativeSource AncestorType=Grid}" Path="ActualWidth"/>
                                        </MultiBinding>
                                    </Rectangle.Width>
                                </Rectangle>
                            </Grid>
                            <StackPanel Orientation="Horizontal">
                                <TextBlock Text="Total Resident On Device: " FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding SummaryData.MemoryUsage.TotalResidentMB, StringFormat={}{0:F1} MB}"/>
                                <TextBlock Text=" / " Margin="5,0"/>
                                <TextBlock Text="Total Allocated: " FontWeight="SemiBold"/>
                                <TextBlock Text="{Binding SummaryData.MemoryUsage.TotalAllocatedMB, StringFormat={}{0:F1} MB}"/>
                            </StackPanel>
                        </StackPanel>
                    </Button>
                    
                    <!-- 对比模式 (不可点击，通过 GridControl 选择) -->
                    <StackPanel Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource BoolToVisibilityConverter}}">
                        <!-- 对比表格 (DevExpress GridControl) -->
                        <dxg:GridControl ItemsSource="{Binding SummaryData.MemoryUsage.Rows}"
                                         Margin="0,0,0,10"
                                         MaxHeight="150"
                                         SelectedItem="{Binding SelectedMemoryUsageRow, Mode=TwoWay}"
                                         SelectionMode="Row">
                            <dxg:GridControl.View>
                                <dxg:TableView AllowEditing="False"
                                               ShowGroupPanel="False"
                                               AutoWidth="True"/>
                            </dxg:GridControl.View>
                            <dxg:GridControl.Columns>
                                <!-- Name 列 -->
                                <dxg:GridColumn Header="Name" FieldName="Name" MinWidth="200" Width="*"/>
                                
                                <!-- A 列 -->
                                <dxg:GridColumn Header="A" FieldName="SizeMB" Width="120" SortOrder="Descending">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedSize}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                                
                                <!-- B 列 -->
                                <dxg:GridColumn Header="B" FieldName="SizeMB_B" Width="120">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedSize_B}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                                
                                <!-- Diff 列 -->
                                <dxg:GridColumn Header="Diff" FieldName="DiffMB" Width="120">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedDiff}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                            </dxg:GridControl.Columns>
                        </dxg:GridControl>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Allocated Memory Distribution -->
            <Border BorderBrush="#E0E0E0" BorderThickness="1" Padding="15" Background="#FAFAFA" Margin="0,0,0,20"
                    Visibility="{Binding SummaryData, Converter={StaticResource NotNullToVisibilityConverter}}">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="Allocated Memory Distribution" FontSize="18" FontWeight="SemiBold"/>
                        <Button Content="Inspect" HorizontalAlignment="Right" Padding="10,5" Background="#2196F3" Foreground="White" BorderThickness="0"
                                Command="{Binding InspectAllOfMemoryCommand}"/>
                        </Grid>
                        <TextBlock Text="Displays how your allocated memory is distributed across memory areas." 
                                   TextWrapping="Wrap" Foreground="Gray" Margin="0,0,0,15"/>
                        
                        <Grid Height="40" Margin="0,0,0,10">
                            <ItemsControl ItemsSource="{Binding SummaryData.MemoryDistribution.Categories}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <StackPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Rectangle Fill="{Binding Color}" Height="40">
                                            <Rectangle.Width>
                                                <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                                    <Binding Path="Percentage"/>
                                                    <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualWidth"/>
                                                </MultiBinding>
                                            </Rectangle.Width>
                                            <Rectangle.ToolTip>
                                                <ToolTip>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                                        <TextBlock Text="{Binding FormattedSize}"/>
                                                    </StackPanel>
                                                </ToolTip>
                                            </Rectangle.ToolTip>
                                        </Rectangle>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </Grid>

                        <TextBlock Margin="0,0,0,5">
                            <Run Text="Total Allocated: " FontWeight="SemiBold"/>
                            <Run Text="{Binding SummaryData.MemoryDistribution.TotalAllocatedMB, StringFormat={}{0:F1} MB, Mode=OneWay}"/>
                        </TextBlock>

                        <!-- 单快照模式 -->
                        <ItemsControl ItemsSource="{Binding SummaryData.MemoryDistribution.Categories}" Margin="0,10,0,0"
                                      Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                <Button Style="{StaticResource SummaryListButtonStyle}"
                                        Command="{Binding DataContext.ShowMemoryCategoryDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                        CommandParameter="{Binding}">
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="20"/>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <Rectangle Grid.Column="0" Width="16" Height="16" Fill="{Binding Color}" Margin="0,0,5,0"/>
                                        <TextBlock Grid.Column="1" Text="{Binding Name}" VerticalAlignment="Center"/>
                                        <TextBlock Grid.Column="2" Text="{Binding FormattedSize}" FontWeight="SemiBold"/>
                                    </Grid>
                                </Button>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                        
                        <!-- 对比模式 - 使用 DevExpress GridControl -->
                        <dxg:GridControl ItemsSource="{Binding SummaryData.MemoryDistribution.Categories}"
                                         Margin="0,10,0,0"
                                         MaxHeight="400"
                                         Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource BoolToVisibilityConverter}}"
                                         SelectedItem="{Binding SelectedMemoryCategory, Mode=TwoWay}"
                                         SelectionMode="Row">
                            <dxg:GridControl.View>
                                <dxg:TableView AllowEditing="False" 
                                               ShowGroupPanel="False" 
                                               AutoWidth="True"/>
                            </dxg:GridControl.View>
                            <dxg:GridControl.Columns>
                                <!-- Name 列（带颜色方块）-->
                                <dxg:GridColumn Header="Name" FieldName="Name" MinWidth="200" Width="*">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <StackPanel Orientation="Horizontal">
                                                <Rectangle Width="16" Height="16" Fill="{Binding Row.Color}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                <TextBlock Text="{Binding Row.Name}" VerticalAlignment="Center"/>
                                            </StackPanel>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                                
                                <!-- A 列 -->
                                <dxg:GridColumn Header="A" FieldName="SizeMB" Width="120" SortOrder="Descending">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedSize}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                                
                                <!-- B 列 -->
                                <dxg:GridColumn Header="B" FieldName="SizeMB_B" Width="120">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedSize_B}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                                
                                <!-- Diff 列 -->
                                <dxg:GridColumn Header="Diff" FieldName="DiffMB" Width="120">
                                    <dxg:GridColumn.CellTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Row.FormattedDiff}" TextAlignment="Right" FontWeight="SemiBold"/>
                                        </DataTemplate>
                                    </dxg:GridColumn.CellTemplate>
                                </dxg:GridColumn>
                            </dxg:GridControl.Columns>
                        </dxg:GridControl>
                    </StackPanel>
                </Border>

            <!-- Managed Heap Utilization -->
            <Border BorderBrush="#E0E0E0" BorderThickness="1" Padding="15" Background="#FAFAFA" Margin="0,0,0,20"
                    Visibility="{Binding SummaryData, Converter={StaticResource NotNullToVisibilityConverter}}">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="Managed Heap Utilization" FontSize="18" FontWeight="SemiBold"/>
                        <Button Content="Inspect" HorizontalAlignment="Right" Padding="10,5" Background="#2196F3" Foreground="White" BorderThickness="0"
                                Command="{Binding InspectManagedCommand}"/>
                        </Grid>
                        <TextBlock Text="Displays a breakdown of the memory that Unity's Scripting VM manages." 
                                   TextWrapping="Wrap" Foreground="Gray" Margin="0,0,0,15"/>
                        
                        <!-- 单快照模式 -->
                        <StackPanel Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <Grid Height="40" Margin="0,0,0,10">
                                <StackPanel Orientation="Horizontal">
                                    <Rectangle Fill="#00BCD4" Height="40">
                                        <Rectangle.Width>
                                            <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                                <Binding Path="SummaryData.HeapUtilization.VirtualMachinePercentage"/>
                                                <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualWidth"/>
                                            </MultiBinding>
                                        </Rectangle.Width>
                                    </Rectangle>
                                    <Rectangle Fill="#FFEB3B" Height="40">
                                        <Rectangle.Width>
                                            <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                                <Binding Path="SummaryData.HeapUtilization.EmptyHeapPercentage"/>
                                                <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualWidth"/>
                                            </MultiBinding>
                                        </Rectangle.Width>
                                    </Rectangle>
                                    <Rectangle Fill="#4CAF50" Height="40">
                                        <Rectangle.Width>
                                            <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                                <Binding Path="SummaryData.HeapUtilization.ObjectsPercentage"/>
                                                <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualWidth"/>
                                            </MultiBinding>
                                        </Rectangle.Width>
                                    </Rectangle>
                                </StackPanel>
                            </Grid>

                            <TextBlock Margin="0,0,0,5">
                                <Run Text="Total: " FontWeight="SemiBold"/>
                                <Run Text="{Binding SummaryData.HeapUtilization.FormattedTotal, Mode=OneWay}"/>
                            </TextBlock>

                            <StackPanel Margin="0,10,0,0">
                            <Button Style="{StaticResource SummaryListButtonStyle}"
                                    Command="{Binding ShowManagedSegmentDetailsCommand}"
                                    CommandParameter="{x:Static vm:SummaryViewModel.ManagedSegmentVirtualMachine}">
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Rectangle Grid.Column="0" Width="16" Height="16" Fill="#00BCD4" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" Text="Virtual Machine"/>
                                    <TextBlock Grid.Column="2" Text="{Binding SummaryData.HeapUtilization.FormattedVirtualMachine}" FontWeight="SemiBold"/>
                                </Grid>
                            </Button>
                            <Button Style="{StaticResource SummaryListButtonStyle}"
                                    Command="{Binding ShowManagedSegmentDetailsCommand}"
                                    CommandParameter="{x:Static vm:SummaryViewModel.ManagedSegmentEmptyHeap}">
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Rectangle Grid.Column="0" Width="16" Height="16" Fill="#FFEB3B" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" Text="Empty Heap Space"/>
                                    <TextBlock Grid.Column="2" Text="{Binding SummaryData.HeapUtilization.FormattedEmptyHeapSpace}" FontWeight="SemiBold"/>
                                </Grid>
                            </Button>
                            <Button Style="{StaticResource SummaryListButtonStyle}"
                                    Command="{Binding ShowManagedSegmentDetailsCommand}"
                                    CommandParameter="{x:Static vm:SummaryViewModel.ManagedSegmentObjects}">
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="20"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    <Rectangle Grid.Column="0" Width="16" Height="16" Fill="#4CAF50" Margin="0,0,5,0"/>
                                    <TextBlock Grid.Column="1" Text="Objects"/>
                                    <TextBlock Grid.Column="2" Text="{Binding SummaryData.HeapUtilization.FormattedObjects}" FontWeight="SemiBold"/>
                                </Grid>
                            </Button>
                            </StackPanel>
                        </StackPanel>

                        <!-- 对比模式 -->
                        <StackPanel Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource BoolToVisibilityConverter}}">
                            <!-- Total 显示 -->
                            <TextBlock Margin="0,0,0,10">
                                <Run Text="Total: " FontWeight="SemiBold"/>
                                <Run Text="{Binding SummaryData.HeapUtilization.FormattedTotal, Mode=OneWay}"/>
                                <Run Text=" → " Foreground="Gray"/>
                                <Run Text="{Binding SummaryData.HeapUtilization.FormattedTotal_B, Mode=OneWay}"/>
                                <Run Text=" (" Foreground="Gray"/>
                                <Run Text="{Binding SummaryData.HeapUtilization.FormattedTotalDiff, Mode=OneWay}" FontWeight="SemiBold"/>
                                <Run Text=")" Foreground="Gray"/>
                            </TextBlock>

                            <!-- 对比表格 (DevExpress GridControl) -->
                            <dxg:GridControl ItemsSource="{Binding SummaryData.HeapUtilization.Rows}"
                                             Margin="0,0,0,10"
                                             MaxHeight="200"
                                             SelectedItem="{Binding SelectedManagedHeapRow, Mode=TwoWay}"
                                             SelectionMode="Row">
                                <dxg:GridControl.View>
                                    <dxg:TableView AllowEditing="False"
                                                   ShowGroupPanel="False"
                                                   AutoWidth="True"/>
                                </dxg:GridControl.View>
                                <dxg:GridControl.Columns>
                                    <!-- Name 列（带颜色方块）-->
                                    <dxg:GridColumn Header="Name" FieldName="Name" MinWidth="200" Width="*">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <Rectangle Width="16" Height="16" Fill="{Binding Row.Color}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Row.Name}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- A 列 -->
                                    <dxg:GridColumn Header="A" FieldName="SizeMB" Width="120" SortOrder="Descending">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedSize}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- B 列 -->
                                    <dxg:GridColumn Header="B" FieldName="SizeMB_B" Width="120">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedSize_B}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- Diff 列 -->
                                    <dxg:GridColumn Header="Diff" FieldName="DiffMB" Width="120">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedDiff}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                </dxg:GridControl.Columns>
                            </dxg:GridControl>
                        </StackPanel>
                    </StackPanel>
                </Border>

            <!-- Top Unity Objects Categories -->
            <Border BorderBrush="#E0E0E0" BorderThickness="1" Padding="15" Background="#FAFAFA" Margin="0,0,0,20"
                    Visibility="{Binding SummaryData, Converter={StaticResource NotNullToVisibilityConverter}}">
                    <StackPanel>
                        <Grid Margin="0,0,0,10">
                            <TextBlock Text="Top Unity Objects Categories" FontSize="18" FontWeight="SemiBold"/>
                        <Button Content="Inspect" HorizontalAlignment="Right" Padding="10,5" Background="#2196F3" Foreground="White" BorderThickness="0"
                                Command="{Binding InspectUnityObjectsCommand}"/>
                        </Grid>
                        <TextBlock Text="Displays which types of Unity Objects use the most memory in the snapshot." 
                                   TextWrapping="Wrap" Foreground="Gray" Margin="0,0,0,15"/>
                        
                        <!-- 单快照模式 -->
                        <StackPanel Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                            <Grid Height="40" Margin="0,0,0,10">
                                <ItemsControl ItemsSource="{Binding SummaryData.TopCategories.Categories}">
                                    <ItemsControl.ItemsPanel>
                                        <ItemsPanelTemplate>
                                            <StackPanel Orientation="Horizontal"/>
                                        </ItemsPanelTemplate>
                                    </ItemsControl.ItemsPanel>
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <Rectangle Fill="{Binding Color}" Height="40">
                                                <Rectangle.Width>
                                                    <MultiBinding Converter="{StaticResource PercentageToWidthConverter}">
                                                        <Binding Path="Percentage"/>
                                                        <Binding RelativeSource="{RelativeSource AncestorType=Border}" Path="ActualWidth"/>
                                                    </MultiBinding>
                                                </Rectangle.Width>
                                                <Rectangle.ToolTip>
                                                    <ToolTip>
                                                        <StackPanel>
                                                            <TextBlock Text="{Binding Name}" FontWeight="Bold"/>
                                                            <TextBlock Text="{Binding FormattedSize}"/>
                                                        </StackPanel>
                                                    </ToolTip>
                                                </Rectangle.ToolTip>
                                            </Rectangle>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </Grid>

                            <TextBlock Margin="0,0,0,5">
                                <Run Text="Total: " FontWeight="SemiBold"/>
                                <Run Text="{Binding SummaryData.TopCategories.TotalMB, StringFormat={}{0:F1} MB, Mode=OneWay}"/>
                            </TextBlock>

                            <ItemsControl ItemsSource="{Binding SummaryData.TopCategories.Categories}" Margin="0,10,0,0">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                    <Button Style="{StaticResource SummaryListButtonStyle}"
                                            Command="{Binding DataContext.ShowUnityCategoryDetailsCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                            CommandParameter="{Binding}">
                                        <Grid Margin="0,2">
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="20"/>
                                                <ColumnDefinition Width="*"/>
                                                <ColumnDefinition Width="Auto"/>
                                            </Grid.ColumnDefinitions>
                                            <Rectangle Grid.Column="0" Width="16" Height="16" Fill="{Binding Color}" Margin="0,0,5,0"/>
                                            <TextBlock Grid.Column="1" Text="{Binding Name}"/>
                                            <TextBlock Grid.Column="2" Text="{Binding FormattedSize}" FontWeight="SemiBold"/>
                                        </Grid>
                                    </Button>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </StackPanel>

                        <!-- 对比模式 -->
                        <StackPanel Visibility="{Binding SummaryData.CompareMode, Converter={StaticResource BoolToVisibilityConverter}}">
                            <!-- Total 显示 -->
                            <TextBlock Margin="0,0,0,10">
                                <Run Text="Total: " FontWeight="SemiBold"/>
                                <Run Text="{Binding SummaryData.TopCategories.TotalMB, StringFormat={}{0:F1} MB, Mode=OneWay}"/>
                            </TextBlock>

                            <!-- 对比表格 (DevExpress GridControl) -->
                            <dxg:GridControl ItemsSource="{Binding SummaryData.TopCategories.Categories}"
                                             Margin="0,0,0,10"
                                             MaxHeight="300"
                                             SelectedItem="{Binding SelectedUnityObjectCategory, Mode=TwoWay}"
                                             SelectionMode="Row">
                                <dxg:GridControl.View>
                                    <dxg:TableView AllowEditing="False"
                                                   ShowGroupPanel="False"
                                                   AutoWidth="True"/>
                                </dxg:GridControl.View>
                                <dxg:GridControl.Columns>
                                    <!-- Name 列（带颜色方块）-->
                                    <dxg:GridColumn Header="Name" FieldName="Name" MinWidth="200" Width="*">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <StackPanel Orientation="Horizontal">
                                                    <Rectangle Width="16" Height="16" Fill="{Binding Row.Color}" Margin="0,0,8,0" VerticalAlignment="Center"/>
                                                    <TextBlock Text="{Binding Row.Name}" VerticalAlignment="Center"/>
                                                </StackPanel>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- A 列 -->
                                    <dxg:GridColumn Header="A" FieldName="SizeMB" Width="120" SortOrder="Descending">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedSize}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- B 列 -->
                                    <dxg:GridColumn Header="B" FieldName="SizeMB_B" Width="120">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedSize_B}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                    
                                    <!-- Diff 列 -->
                                    <dxg:GridColumn Header="Diff" FieldName="DiffMB" Width="120">
                                        <dxg:GridColumn.CellTemplate>
                                            <DataTemplate>
                                                <TextBlock Text="{Binding Row.FormattedDiff}" TextAlignment="Right" FontWeight="SemiBold"/>
                                            </DataTemplate>
                                        </dxg:GridColumn.CellTemplate>
                                    </dxg:GridColumn>
                                </dxg:GridControl.Columns>
                            </dxg:GridControl>
                        </StackPanel>
                    </StackPanel>
                </Border>
        </StackPanel>
    </ScrollViewer>
</UserControl>

