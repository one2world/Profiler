<UserControl x:Class="Unity.MemoryProfiler.UI.Views.Comparison.AllTrackedMemoryComparisonView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:dxg="http://schemas.devexpress.com/winfx/2008/xaml/grid"
             xmlns:dx="http://schemas.devexpress.com/winfx/2008/xaml/core"
             xmlns:local="clr-namespace:Unity.MemoryProfiler.UI.Views.Comparison"
             xmlns:converters="clr-namespace:Unity.MemoryProfiler.UI.Converters"
             mc:Ignorable="d" 
             d:DesignHeight="800" d:DesignWidth="1200">

    <UserControl.Resources>
        <!-- BytesToStringConverter已过时，此文件将在阶段8删除 -->
        <converters:BytesToStringConverter x:Key="BytesToStringConverter"/>
        <converters:DeltaToColorConverter x:Key="DeltaToColorConverter"/>
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        
        <!-- Delta Bar Converter -->
        <converters:DeltaBarWidthConverter x:Key="DeltaBarWidthConverter"/>
    </UserControl.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/> <!-- 工具栏 -->
            <RowDefinition Height="Auto"/> <!-- 描述和进度条 -->
            <RowDefinition Height="*"/>    <!-- 主内容 -->
        </Grid.RowDefinitions>

        <!-- 工具栏 -->
        <Border Grid.Row="0" Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}" 
                Padding="5" BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}" 
                BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal">
                <TextBlock Text="Search:" VerticalAlignment="Center" Margin="0,0,5,0"/>
                <TextBox Width="200" Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" 
                         VerticalAlignment="Center" Margin="0,0,10,0"/>
                <Button Content="Search" Command="{Binding SearchCommand}" 
                        Padding="10,3" Margin="0,0,10,0"/>
                <CheckBox Content="Show Unchanged" IsChecked="{Binding ShowUnchanged}" 
                          VerticalAlignment="Center" Margin="10,0,0,0"/>
            </StackPanel>
        </Border>

        <!-- 描述和进度条 -->
        <StackPanel Grid.Row="1" Margin="10">
            <TextBlock Text="{Binding DescriptionText}" FontWeight="Bold" Margin="0,0,0,10"/>
            
            <!-- Base Total Size Bar -->
            <Grid Margin="0,0,0,5">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Base:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="Bold"/>
                <ProgressBar Grid.Column="1" Height="20" 
                             Value="{Binding TotalSizeA}" 
                             Maximum="{Binding MaxValue}"/>
                <TextBlock Grid.Column="2" VerticalAlignment="Center" Margin="5,0,0,0">
                    <Run Text="Table: "/><Run Text="{Binding TotalSizeAText, Mode=OneWay}"/>
                    <Run Text=" | Total: "/><Run Text="{Binding TotalSnapshotSizeA, Converter={StaticResource BytesToStringConverter}, Mode=OneWay}"/>
                </TextBlock>
            </Grid>

            <!-- Compared Total Size Bar -->
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Grid.Column="0" Text="Compared:" VerticalAlignment="Center" Margin="0,0,5,0" FontWeight="Bold"/>
                <ProgressBar Grid.Column="1" Height="20" 
                             Value="{Binding TotalSizeB}" 
                             Maximum="{Binding MaxValue}"/>
                <TextBlock Grid.Column="2" VerticalAlignment="Center" Margin="5,0,0,0">
                    <Run Text="Table: "/><Run Text="{Binding TotalSizeBText, Mode=OneWay}"/>
                    <Run Text=" | Total: "/><Run Text="{Binding TotalSnapshotSizeB, Converter={StaticResource BytesToStringConverter}, Mode=OneWay}"/>
                </TextBlock>
            </Grid>
        </StackPanel>

        <!-- 主内容 -->
        <Grid Grid.Row="2">
            <Grid.RowDefinitions>
                <RowDefinition Height="2*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- 对比TreeListControl -->
            <dxg:TreeListControl Grid.Row="0" 
                                 ItemsSource="{Binding ComparisonRootNodes}"
                                 SelectedItem="{Binding SelectedNode, Mode=TwoWay}"
                                 AutoGenerateColumns="False"
                                 SelectionMode="Row"
                                 ShowBorder="True"
                                 Margin="10,0,10,5">
                <dxg:TreeListControl.Columns>
                    <!-- Description列 -->
                    <dxg:TreeListColumn FieldName="Data.Name" Header="Description" Width="*" MinWidth="200"/>

                    <!-- Count Delta列 -->
                    <dxg:TreeListColumn FieldName="Data.CountDelta" Header="Count Δ" Width="100">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RowData.Row.Data.CountDelta, StringFormat='+#;-#;0'}"
                                           Foreground="{Binding RowData.Row.Data.CountDelta, Converter={StaticResource DeltaToColorConverter}}"
                                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Size Delta Bar列 -->
                    <dxg:TreeListColumn Header="Size Δ Bar" Width="150">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <Grid>
                                    <Rectangle Fill="{Binding RowData.Row.Data.SizeDelta, Converter={StaticResource DeltaToColorConverter}}"
                                               Width="{Binding RowData.Row.Data.SizeDelta, Converter={StaticResource DeltaBarWidthConverter}}"
                                               Height="14"
                                               HorizontalAlignment="Center"/>
                                </Grid>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Size Delta列 -->
                    <dxg:TreeListColumn FieldName="Data.SizeDelta" Header="Size Δ" Width="120">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <Border Background="#30000000" Padding="3,0">
                                    <TextBlock Text="{Binding RowData.Row.Data.SizeDelta, Converter={StaticResource BytesToStringConverter}}"
                                               Foreground="{Binding RowData.Row.Data.SizeDelta, Converter={StaticResource DeltaToColorConverter}}"
                                               HorizontalAlignment="Right"/>
                                </Border>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Size In A列 -->
                    <dxg:TreeListColumn FieldName="Data.TotalSizeInA" Header="Size In A" Width="120">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RowData.Row.Data.TotalSizeInA, Converter={StaticResource BytesToStringConverter}}"
                                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Size In B列 -->
                    <dxg:TreeListColumn FieldName="Data.TotalSizeInB" Header="Size In B" Width="120">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RowData.Row.Data.TotalSizeInB, Converter={StaticResource BytesToStringConverter}}"
                                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Count In A列 -->
                    <dxg:TreeListColumn FieldName="Data.CountInA" Header="Count In A" Width="100">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RowData.Row.Data.CountInA, StringFormat=N0}"
                                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>

                    <!-- Count In B列 -->
                    <dxg:TreeListColumn FieldName="Data.CountInB" Header="Count In B" Width="100">
                        <dxg:TreeListColumn.CellTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding RowData.Row.Data.CountInB, StringFormat=N0}"
                                           HorizontalAlignment="Right"/>
                            </DataTemplate>
                        </dxg:TreeListColumn.CellTemplate>
                    </dxg:TreeListColumn>
                </dxg:TreeListControl.Columns>

                <!-- TreeList View -->
                <dxg:TreeListControl.View>
                    <dxg:TreeListView AutoWidth="False"
                                      NavigationStyle="Row"
                                      ShowIndicator="False"
                                      TreeDerivationMode="ChildNodesSelector"
                                      ChildNodesSelector="{Binding Path=Children}"/>
                </dxg:TreeListControl.View>
            </dxg:TreeListControl>

            <!-- GridSplitter -->
            <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" 
                          Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"/>

            <!-- Base和Compared详细信息 -->
            <Grid Grid.Row="2" Margin="10,5,10,10">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Base详细信息 -->
                <Border Grid.Row="0" BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}" 
                        BorderThickness="1" Padding="10">
                    <StackPanel>
                        <TextBlock Text="Base (A)" FontWeight="Bold" FontSize="14" Margin="0,0,0,5"/>
                        <TextBlock Text="{Binding BaseDescriptionText}" Foreground="Gray"/>
                    </StackPanel>
                </Border>

                <!-- 分隔线 -->
                <GridSplitter Grid.Row="1" Height="5" HorizontalAlignment="Stretch" 
                              Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"/>

                <!-- Compared详细信息 -->
                <Border Grid.Row="2" BorderBrush="{DynamicResource {x:Static SystemColors.ActiveBorderBrushKey}}" 
                        BorderThickness="1" Padding="10">
                    <StackPanel>
                        <TextBlock Text="Compared (B)" FontWeight="Bold" FontSize="14" Margin="0,0,0,5"/>
                        <TextBlock Text="{Binding ComparedDescriptionText}" Foreground="Gray"/>
                    </StackPanel>
                </Border>
            </Grid>
        </Grid>

        <!-- Loading Overlay -->
        <Grid Grid.RowSpan="3" Background="#80000000" 
              Visibility="{Binding IsBusy, Converter={StaticResource BoolToVisibilityConverter}}">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center">
                <dx:LoadingDecorator BorderEffect="Default" />
                <TextBlock Text="{Binding StatusMessage}" Foreground="White" 
                           FontSize="14" Margin="0,10,0,0" HorizontalAlignment="Center"/>
            </StackPanel>
        </Grid>
    </Grid>
</UserControl>

