# Unity Memory Profiler WPF - å¿«é€Ÿå‚è€ƒ

## ğŸ“Š é¡¹ç›®å½“å‰çŠ¶æ€

**æ€»ä½“å®Œæˆåº¦**: **80%**  
**ä¸»è¦å·®è·**: PathsToRoot æ·±åº¦å®ç°ã€Memory Map è§†å›¾ã€è¿‡æ»¤åŠŸèƒ½å¢å¼º

---

## ğŸš¨ ç«‹å³éœ€è¦å¤„ç†çš„é—®é¢˜

### 1. TreeListView ç¼ºå¤± âš ï¸ CRITICAL
**å½±å“**: é¡¹ç›®æ— æ³•ç¼–è¯‘  
**åŸå› **: `TreeListView.cs` å’Œ `.xaml` å·²åˆ é™¤,ä½†ä»è¢«å¼•ç”¨  
**è§£å†³æ–¹æ¡ˆ**: è¿ç§»åˆ° DevExpress TreeListControl

```bash
# æ£€æŸ¥ç¼–è¯‘çŠ¶æ€
cd E:\1_code_new\Profiler
dotnet build UnityMemoryProfilerWPF.sln
```

### 2. æœªæäº¤çš„ä¿®æ”¹
**æ–‡ä»¶åˆ—è¡¨**:
- `Unity.MemoryProfiler.UI/Controls/ManagedObjectInspector.xaml.cs`
- `Unity.MemoryProfiler.UI/Controls/SelectionDetailsPanel.xaml.cs`
- `Unity.MemoryProfiler.UI/MainWindow.xaml.cs`
- `Unity.MemoryProfiler.UI/Models/SnapshotIssuesModelBuilder.cs`
- `Unity.MemoryProfiler.UI/Views/AllTrackedMemoryView.xaml`
- `Unity.MemoryProfiler.UI/Views/UnityObjectsView.xaml.cs`

**å»ºè®®**: å…ˆéªŒè¯ç¼–è¯‘,å†å†³å®šæäº¤æˆ–å›æ»š

---

## ğŸ“‹ åŠŸèƒ½å®Œæˆåº¦ä¸€è§ˆè¡¨

| æ¨¡å— | å®Œæˆåº¦ | çŠ¶æ€ | ä¸»è¦é—®é¢˜ |
|------|--------|------|---------|
| **Summary** | 97% | âœ… ä¼˜ç§€ | UI åŠ¨ç”»ç»†èŠ‚ |
| **Unity Objects** | 75% | âš ï¸ éœ€å®Œå–„ | ç¼ºå°‘åˆ—ã€è¿‡æ»¤ã€å³é”®èœå• |
| **All Of Memory** | 90% | âœ… è‰¯å¥½ | è¿‡æ»¤åŠŸèƒ½ã€æ ·å¼ä¼˜åŒ– |
| **Selection Details** | 75% | âš ï¸ éœ€å®Œå–„ | PathsToRoot æ·±åº¦ä¸è¶³ |
| **å¿«ç…§ç®¡ç†** | 60% | âš ï¸ éœ€å®Œå–„ | æ–‡ä»¶æµè§ˆã€æ‹–æ”¾ |
| **Memory Map** | 0% | âŒ ç¼ºå¤± | å®Œå…¨æœªå®ç° |
| **æ•°æ®æ¨¡å‹** | 90% | âœ… è‰¯å¥½ | æ ¸å¿ƒé€»è¾‘å®Œæ•´ |

---

## ğŸ¯ æ ¸å¿ƒå¾…åŠäº‹é¡¹ (æŒ‰ä¼˜å…ˆçº§)

### ğŸ”´ P0 - ç´§æ€¥ (æœ¬å‘¨å¿…é¡»å®Œæˆ)
- [x] ~~ä¿®å¤ TreeListView ç¼ºå¤±é—®é¢˜~~ âœ… **å·²å®Œæˆ** (å·²è¿ç§»åˆ° DevExpress TreeListControl)
- [ ] éªŒè¯é¡¹ç›®ç¼–è¯‘çŠ¶æ€ (30åˆ†é’Ÿ)
  ```bash
  dotnet build UnityMemoryProfilerWPF.sln
  ```
- [ ] å¤„ç†æœªæäº¤ä¿®æ”¹ (1 å°æ—¶)

### ğŸŸ  P1 - é‡è¦ (1-2 å‘¨å†…å®Œæˆ)
- [ ] æ·±åº¦å®ç° PathsToRoot åŠŸèƒ½ (3-5 å¤©)
  - [ ] å®ç°å¼•ç”¨éå†ç®—æ³•
  - [ ] é€’å½’æ„å»ºå®Œæ•´è·¯å¾„æ ‘
  - [ ] æ ‡è¯† GC Root
  - [ ] æµ‹è¯•éªŒè¯
  
- [ ] å®Œå–„è¿‡æ»¤å’Œæœç´¢åŠŸèƒ½ (2-3 å¤©)
  - [ ] å®ç°é«˜çº§è¿‡æ»¤å™¨ (æ­£åˆ™ã€å¤§å°èŒƒå›´ã€ç±»å‹)
  - [ ] æ›´æ–° UI æ·»åŠ è¿‡æ»¤é¢æ¿
  - [ ] Unity Objects å’Œ All Of Memory éƒ½éœ€è¦
  
- [ ] è¡¥å…¨ Unity Objects è§†å›¾ (1-2 å¤©)
  - [ ] æ·»åŠ  Native Instance ID åˆ—
  - [ ] æ·»åŠ  Address åˆ—
  - [ ] å®ç°å³é”®èœå• (Copy Name, Copy Type)

### ğŸŸ¡ P2 - ä¸€èˆ¬ (3-4 å‘¨å†…å®Œæˆ)
- [ ] å®ç° Memory Map è§†å›¾ (3-4 å¤©)
  - [ ] åˆ›å»º MemoryMapViewModel
  - [ ] åˆ›å»º MemoryMapView UI
  - [ ] å®ç°åœ°å€ç©ºé—´å¯è§†åŒ–
  - [ ] é›†æˆåˆ°ä¸»çª—å£
  
- [ ] UI/UX ä¼˜åŒ– (2-3 å¤©)
  - [ ] ç»Ÿä¸€æ ·å¼å’Œä¸»é¢˜
  - [ ] æ·»åŠ  Tooltip
  - [ ] ä¼˜åŒ–äº¤äº’ç»†èŠ‚

### ğŸŸ¢ P3 - å¯é€‰ (æ—¶é—´å……è£•æ—¶)
- [ ] æ¶æ„é‡æ„ (å¼•å…¥ SnapshotDataService)
- [ ] æ€§èƒ½ä¼˜åŒ– (å¤§å¿«ç…§åŠ è½½)
- [ ] ç¼–å†™æ–‡æ¡£ (ç”¨æˆ·æ‰‹å†Œã€å¼€å‘è€…æ–‡æ¡£)

---

## ğŸ”§ å…³é”®ä»£ç ä½ç½®å¯¹ç…§

### Unity åŸç‰ˆ â†’ WPF å®ç°

| åŠŸèƒ½ | Unity åŸç‰ˆ | WPF å®ç° |
|------|-----------|----------|
| ä¸»çª—å£ | `MemoryProfilerWindow.cs` | `MainWindow.xaml.cs` |
| Summary | `SummaryViewController.cs` | `SummaryViewModel.cs` |
| Unity Objects | `UnityObjectsBreakdownViewController.cs` | `UnityObjectsViewModel.cs` |
| All Of Memory | `AllTrackedMemoryBreakdownViewController.cs` | `AllTrackedMemoryViewModel.cs` |
| Selection Details | `SelectedItemDetailsPanel.cs` | `SelectionDetailsPanel.xaml.cs` |
| PathsToRoot | `PathsToRootDetailView.cs` | `PathsToRootView.xaml.cs` |
| Managed Inspector | `ManagedObjectInspector.cs` | `ManagedObjectInspector.xaml.cs` |
| AllTrackedMemory Builder | `AllTrackedMemoryModelBuilder.cs` (Line 14-1503) | `AllTrackedMemoryModelBuilder.Part1/2/3.cs` |
| Unity Objects Builder | `UnityObjectsModelBuilder.cs` | `UnityObjectsModelBuilder.cs` |
| Summary Builder | `AllMemorySummaryModelBuilder.cs` | `AllMemorySummaryModelBuilder.cs` |

---

## ğŸ’¡ å¸¸è§é—®é¢˜å¿«é€Ÿè§£å†³

### Q1: Unity Memory Profiler æœ‰ Memory Map åŠŸèƒ½å—ï¼Ÿ

**ç­”**: âœ… **æœ‰ï¼** Unity Memory Profiler 1.1.6 åŒ…å«å®Œæ•´çš„ Memory Map åŠŸèƒ½ã€‚

**åŸç‰ˆå®ç°**:
- **ä½ç½®**: `References/com.unity.memoryprofiler@1.1.6/Editor/UI/Analysis/Breakdowns/MemoryMap/`
- **æ ¸å¿ƒæ–‡ä»¶**:
  - `MemoryMapBreakdownViewController.cs` - è§†å›¾æ§åˆ¶å™¨
  - `MemoryMapBreakdownModel.cs` - æ•°æ®æ¨¡å‹
  - `MemoryMapBreakdownModelBuilder.cs` - æ„å»ºå™¨
  - `MemoryMapBreakdownView.uxml` - UI å¸ƒå±€

**åŠŸèƒ½**:
- æ˜¾ç¤ºå†…å­˜åœ°å€ç©ºé—´çš„å±‚æ¬¡ç»“æ„ (Address, Size, Type, Name)
- æ”¯æŒ Resident Size (å¸¸é©»å†…å­˜)
- æŒ‰åœ°å€/å¤§å°/ç±»å‹æ’åº
- åŒºåˆ† System Regionã€Unity Allocatorã€Native/Managed Objectsã€Graphics Objects

**æ•°æ®æº**: `snapshot.EntriesMemoryMap` (å†…å­˜åœ°å€æ˜ å°„)

**WPF å¤åˆ»çŠ¶æ€**: âŒ å°šæœªå®ç° (è§å¼€å‘è®¡åˆ’é˜¶æ®µ4)

### Q2: å¦‚ä½•å®ç° PathsToRoot é€’å½’éå†?

æ ¸å¿ƒé€»è¾‘å‚è€ƒ:
```csharp
// Unity.MemoryProfiler.UI/Services/PathsToRootBuilder.cs
private void BuildReferencedByRecursive(
    SourceIndex currentIndex,
    int depth,
    HashSet<SourceIndex> visited,
    List<ReferencePathNode> currentLevel,
    ref int pathCount)
{
    // 1. æ·±åº¦é™åˆ¶
    if (depth >= _maxDepth) return;
    
    // 2. å¾ªç¯å¼•ç”¨æ£€æµ‹
    if (visited.Contains(currentIndex)) return;
    visited.Add(currentIndex);
    
    // 3. è·å–æ‰€æœ‰å¼•ç”¨æ­¤å¯¹è±¡çš„å¯¹è±¡
    var referencers = GetReferencers(currentIndex);
    
    // 4. é€’å½’æ„å»º
    foreach (var referencer in referencers)
    {
        var node = CreateNode(referencer);
        currentLevel.Add(node);
        
        if (!node.IsGCRoot)
        {
            node.Children = new List<...>();
            BuildReferencedByRecursive(referencer.From, depth + 1, ...);
        }
    }
}
```

### Q3: å¦‚ä½•è·å–å¯¹è±¡çš„æ‰€æœ‰å¼•ç”¨è€…?

```csharp
private List<ConnectionInfo> GetReferencers(SourceIndex targetIndex)
{
    var referencers = new List<ConnectionInfo>();
    var connections = _snapshot.CrawledData.Connections;
    
    // åå‘æŸ¥æ‰¾: æ‰€æœ‰ to == targetIndex çš„ from
    for (int i = 0; i < connections.ManagedObjectsConnectedToArray.Length; i++)
    {
        var toIndex = connections.ManagedObjectsConnectedToArray[i];
        if (toIndex == targetIndex.Index)
        {
            var fromIndex = connections.ManagedObjectsConnectedFromArray[i];
            referencers.Add(new ConnectionInfo { From = fromIndex, To = targetIndex });
        }
    }
    
    return referencers;
}
```

### Q4: å¦‚ä½•åˆ¤æ–­æ˜¯å¦ä¸º GC Root?

```csharp
private bool IsGCRoot(SourceIndex index)
{
    if (index.Id == SourceIndex.SourceId.ManagedObject)
    {
        var objectIndex = index.Index;
        
        // 1. æ£€æŸ¥ GCHandles
        if (_snapshot.CrawledData.GCHandles.Target.Contains(objectIndex))
            return true;
        
        // 2. æ£€æŸ¥é™æ€å­—æ®µ
        // (éœ€è¦æ·±å…¥è§£æ TypeDescription.StaticFieldBytes)
        
        // 3. æ£€æŸ¥æ ˆå¼•ç”¨
        // (å‚è€ƒ Unity ObjectConnection.cs)
    }
    
    return false;
}
```

---

## ğŸ“– ç›¸å…³æ–‡æ¡£

- **è¯¦ç»†åˆ†ææŠ¥å‘Š**: `Unity Memory Profiler å¤åˆ»é¡¹ç›®æ·±åº¦åˆ†ææŠ¥å‘Š.md`
- **å®Œæ•´å¼€å‘è®¡åˆ’**: `å¼€å‘è®¡åˆ’.md`
- **Unity å®˜æ–¹æ–‡æ¡£**: https://docs.unity3d.com/Packages/com.unity.memoryprofiler@1.1/manual/

---

## ğŸ› ï¸ å¸¸ç”¨å‘½ä»¤

```bash
# æ¸…ç†å¹¶é‡æ–°æ„å»º
cd E:\1_code_new\Profiler
dotnet clean
dotnet restore
dotnet build UnityMemoryProfilerWPF.sln -c Debug

# è¿è¡Œé¡¹ç›®
dotnet run --project Unity.MemoryProfiler.UI/Unity.MemoryProfiler.UI.csproj

# Git æ“ä½œ
git status
git diff --stat
git add .
git commit -m "feat(treelist): Migrate to DevExpress TreeListControl"

# æš‚å­˜æœªæäº¤ä¿®æ”¹
git stash save "WIP: TreeListView migration"
git stash pop
```

---

## ğŸ“ éœ€è¦å¸®åŠ©æ—¶

å¦‚æœåœ¨å®ç°è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜,å¯ä»¥:

1. **æŸ¥çœ‹ Unity åŸç‰ˆä»£ç **  
   è·¯å¾„: `References/com.unity.memoryprofiler@1.1.6/Editor/`
   
2. **æŸ¥é˜… DevExpress æ–‡æ¡£**  
   https://docs.devexpress.com/WPF/
   
3. **å‚è€ƒ CachedSnapshot API**  
   æ ¸å¿ƒç±»: `Unity.MemoryProfiler.Editor.CachedSnapshot`

---

**æœ€åæ›´æ–°**: 2025-11-13  
**ç‰ˆæœ¬**: 1.0

